
<html lang="en" ng-app="Stock-CMS">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Escrow Suspended REQUESTLETTER</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            text-indent: 0;
        }

        h1 {
            color: black;
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 18pt;
            text-decoration: none;
        }

        /* Text Styles */
        .s1 {
            color: black;
            font-family: Calibri, sans-serif;
            font-size: 14pt;
        }

        .s2 {
            color: black;
            font-family: "Times New Roman", serif;
            font-size: 12pt;
        }

        .p, p {
            color: black;
            font-family: Calibri, sans-serif;
            font-size: 12pt;
            margin: 0;
        }

        .s3 {
            color: black;
            font-family: Calibri, sans-serif;
            font-size: 12pt;
            text-decoration: underline;
        }

        .s4 {
            color: black;
            font-family: Cambria, serif;
            font-size: 10pt;
        }

        .s5 {
            color: black;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 11pt;
            text-decoration: underline;
        }

        .s7 {
            color: black;
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 11pt;
        }

        .h3 {
            color: #212121;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 11pt;
            text-decoration: underline;
        }

        .s8,
        .s9 {
            color: black;
            font-family: Calibri, sans-serif;
            font-size: 11pt;
        }

        /* Components */
        .card {
            border-radius: 10px;
            overflow: hidden;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        /* Buttons */
        .btn-primary {
            width: 100%;
            padding: 12px 16px;
            text-transform: uppercase;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

            .btn-primary:hover {
                background-color: #0056b3;
                transform: scale(1.05);
            }

        .mybtn {
            background-color: #51b37f !important;
            color: white !important;
            width: auto !important;
        }

        .myarea {
            display: flex !important;
            justify-content: center !important;
            margin-top: 25px !important;
        }
    </style>

</head>

<body style="padding: 5%; padding-top: 5%" ng-controller="FormController">
    <div class="row align-items-center">
        <!-- Arrow Icon aligned to the left -->
        <a class="col-md-1 text-start" style="font-size:35px;" ng-click="navtogenerateform()">
            <i class="bi bi-arrow-left"></i>
        </a>

        <!-- Centered Heading -->
        <div class="col-md-10 text-center">
            <h3>Escrow Suspended REQUEST LETTER</h3>
        </div>
    </div>

    <div ng-if="hDiv" class="container my-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <form name="gForm" ng-submit="genrateForm()">
                    <h4 class="card-title text-center mb-4" style="color:#51b37f;">Generate Form</h4>
                    <div class="row">
                        <!-- Select Customer Dropdown -->
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                <label for="seletedId" class="form-label">Select Customer</label>
                                <select class="form-select" id="seletedId" ng-options="f.id as f.name for f in docs" ng-model="seletedId" ng-change="loadCustomers(seletedId, heirId)">
                                    <option selected disabled value="">Select customer</option>
                                </select>
                            </div>
                        </div>

                        <!-- Select Heir Dropdown -->
                        <div class="col-md-4 mb-3" ng-show="legalheirlist">
                            <div class="form-group">
                                <label for="heirId" class="form-label">Select Heir</label>
                                <select class="form-select" id="heirId" ng-options="g.id as g.name for g in heir" ng-model="heirId" ng-change="loadCustomers(seletedId, heirId)">
                                    <option selected disabled value="">Select Heir</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                <label for="accountName" class="form-label">Demat Account Name</label>
                                <input type="text" ng-model="data.accountName" class="form-control" placeholder="Demat Account Name">
                            </div>
                        </div>
                    </div>
                    <!-- Submit Button -->
                    <div class="col-md-4 text-center m-2">
                        <button type="submit" ng-disabled="processdone" class="btn btn-primary" style="background-color:#51b37f; color:white; border-radius: 5px;">
                            Generate Form
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="printForm">
        <h1 style="padding-left: 5pt;text-indent: 0pt;line-height: 22pt;text-align: left;">@* Nayantara Shah *@
            <span ng-show="!data.condition" ng-class="{'hide-print': data.condition}">
                <span ng-show="!data.firstAlive" ng-style="{'color': data.firstAlive ? 'red' : 'inherit', 'display': data.firstAlive ? 'none' : 'flex'}">{{ data.firstHolder}}</span>
                <span ng-if="data.secondHolder" ng-show="!data.secondAlive" ng-style="{'display': data.secondAlive ? 'none' : 'flex'}">
                    &
                    <span ng-style="{'color': data.secondAlive ? 'red' : 'inherit'}">
                        {{data.secondHolder}}
                    </span>
                </span>
                <span ng-if="data.thirdHolder" ng-show="!data.thirdAlive" ng-style="{'display': data.thirdAlive ? 'none' : 'flex'}">
                    &
                    <span ng-style="{'color': data.thirdAlive ? 'red' : 'inherit'}">
                        {{data.thirdHolder}}
                    </span>
                </span>
            </span><span ng-show="data.condition && !h.dateOfDeath" ng-class="{'hide-print': !data.condition}">
                <span ng-repeat="h in data.heirs track by $index">
                    <span ng-style="{'color': h.dateOfDeath ? 'red' : 'inherit', 'display': h.dateOfDeath ? 'none' : 'flex'}">
                        {{h.name}}
                    </span><span ng-if="$index < data.heirs.length - 1"> & </span>
                </span>
            </span>
        </h1>
        <p class="s1" style="padding-left: 5pt;text-indent: 0pt;line-height: 17pt;text-align: left;">
           @*  shreekunj C - 13
            zaverchand park society *@{{data.address}}
        @* </p>
        <p class="s1" style="padding-left: 5pt;text-indent: 0pt;text-align: left;">
            behind sterling health mall old padra
            road Vadodara Akota Padra Vadodara *@
        </p>
        <p class="s1" style="padding-left: 5pt;text-indent: 0pt;line-height: 17pt;text-align: left;">@* Gujarat 390020 *@
            M. No. @* 94281 71249 *@ {{data.mobile}}</p>
        <p style="padding-top: 3pt;text-indent: 0pt;text-align: left;"><br /></p>
        <hr style="border: 1px; height: 2px; background-color: black;">
        <p style="padding-left: 5pt;text-indent: 0pt;line-height: 1pt;text-align: left;" />
        <div style="display: flex; justify-content: space-between;">
            <p class="s2" style="padding-top: 1pt; padding-left: 5pt; text-indent: 0pt; text-align: left;">
                To
            </p>
            <p class="s2" style="padding-top: 1pt; padding-left: 5pt; text-indent: 0pt; text-align: right;">
                Date: @* {{data.today | date:'dd/MM/yyyy'}} *@<u> &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;</u>
            </p>
        </div>
        <p class="s4" style="padding-left: 5pt;text-indent: 0pt;line-height: 109%;text-align: left;">
            @* Integrated Registry
            Management Services Pvt. Ltd (Integrated Enterprises (India) Ltd), *@ {{data.officename}}
        </p>
        <p class="s4" style="padding-left: 5pt;text-indent: 0pt;line-height: 107%;text-align: left;">
            @* 30, Ramana Residency,
            4th Cross, Sampige Road, Malleswaram, Bengaluru, Karnataka,560003 *@ {{data.officeaddress}}
        </p>
        <p style="text-indent: 0pt;text-align: left;"><br /></p>
        <p class="s7" style="text-indent: 0pt;text-align: center;">
            <span class="s5">Sub</span><u>.:</u> <span class="h3">Unclaimed Shares Suspense Escrow Demat account (SEDA)</span>
        </p>
        <p style="text-indent: 0pt;text-align: left;"><br /></p>
        <p class="s7" style="padding-left: 5pt;text-indent: 0pt;text-align: left;">
            UNIT: <span class="s8">
               @*  United Spirits
                Ltd *@ {{data.unit}}
            </span>
        </p>
        <p class="s7" style="padding-left: 5pt;text-indent: 0pt;text-align: left; display: flex; justify-content: space-between;">
            <span class="p">
                Folio NO:
                @* 00000 *@ {{data.folioNo}}
            </span><span class="s8">Number of Shares: @* 200 *@ {{data.qty}}</span>
        </p>
        <p style="padding-top: 2pt;text-indent: 0pt;text-align: left;"><br /></p>
        <p class="s7" style="padding-left: 5pt;text-indent: 0pt;text-align: left;">
            DP ID: <span class="s3">@* 00000000 *@ {{data.dpid}}</span>
        </p>
        <p class="s7" style="padding-top: 1pt;padding-left: 5pt;text-indent: 0pt;text-align: left;">
            Client ID: <span class="s3">@* 00000000 *@ {{data.clientId}}</span>
        </p>
        <p style="padding-top: 2pt;text-indent: 0pt;text-align: left;"><br /></p>
        <p style="padding-left: 5pt;text-indent: 0pt;text-align: left;">Dear Sir,</p>
        <p style="padding-top: 2pt;text-indent: 0pt;text-align: left;"><br /></p>
        <p style="padding-left: 5pt;text-indent: 0pt;line-height: 108%;text-align: justify;">
            This is to inform you that, I
            have holding of shares in above mentioned company name <b>@* United Spirits Ltd *@ {{data.unit}} </b>folio number <b>@* 00000 *@ {{data.folioNo}} </b>are
            in your <span class="h3">@* Suspense Escrow Demat account *@{{data.accountName}}</span>, I would like to request you to please credit all
            the shares in above mentioned folio number to direct Demat account, herewith I attached original Client Master
            for Demat reference and other documents for your ready reference.
        </p>
        <p style="text-indent: 0pt;text-align: left;"><br /></p>
        <p style="padding-left: 5pt;text-indent: 0pt;text-align: left;">
            Kindly acknowledge the receipt and please do the
            needful the earliest<span class="s9">.</span>
        </p>
        <p style="text-indent: 0pt;text-align: left;"><br /></p>
        <p class="s8" style="padding-left: 5pt;text-indent: 0pt;text-align: left;">Holder(s) Signature(s)</p>
        <p style="text-indent: 0pt;text-align: left;"><br /></p>
        <p style="text-indent: 0pt;text-align: left;"><br /></p>
        <h1 style="padding-left: 5pt;text-indent: 0pt;text-align: justify;">@* Nayantara Shah *@
            <b ng-show="!data.condition && !data.firstAlive" ng-class="{'hide-print': data.condition}" ng-style="{'color': data.firstAlive ? 'red' : 'inherit', 'display': data.firstAlive ? 'none' : 'flex'}">{{data.firstHolder}}</b>
            <b ng-show="!data.condition && !data.secondAlive" ng-class="{'hide-print': data.condition}" ng-style="{'color': data.secondAlive ? 'red' : 'inherit', 'display': data.secondAlive ? 'none' : 'flex'}">{{data.secondHolder}}</b>
            <b ng-show="!data.condition && !data.thirdAlive" ng-class="{'hide-print': data.condition}" ng-style="{'color': data.thirdAlive ? 'red' : 'inherit', 'display': data.thirdAlive ? 'none' : 'flex'}">{{data.thirdHolder}}</b>
            <b ng-show="data.condition && !h.dateOfDeath" ng-class="{'hide-print': !data.condition}" ng-repeat="h in data.heirs" ng-style="{'color': h.dateOfDeath ? 'red' : 'inherit', 'display': h.dateOfDeath ? 'none' : 'flex'}">  {{h.name}}</b>
        </h1>
    </div>
    <div class="myarea">
        <button class="btn btn-store mybtn" ng-click="printDiv('printForm')">PRINT</button>
    </div>
</body>
</html>

<script>
    angular.module('Stock-CMS', [])
        .controller('FormController', function ($scope, $http, $timeout) {

            $scope.customers = [];
            $scope.hDiv = true;

            var params = new URLSearchParams(window.location.search);
            var id = params.get('id');
            var id2 = params.get('id2');

            var isProcessing = false;
            $scope.processdone = false;

            // ------------------------------------------------------------
            // Load Customers / Stock Data
            // ------------------------------------------------------------
            $scope.loadCustomers = function (sid, hid) {

                if (id) {

                    hideLoader();
                    $scope.hDiv = true;

                    $http.get('/Enquiry/GetStocksById/' + id).then(function (response) {

                        var result = response.data;

                        $http.get('/Form/GetHolderByStockId/' + id).then(function (response) {

                            $scope.docs = response.data;
                            var doc = $scope.docs.find(x => x.id === sid);
                            var isDeceased = !!doc?.dateOfDeath;

                            if (isDeceased) {

                                $scope.heirId = null;
                                $scope.legalheirlist = true;
                                document.getElementById('heirId').value = '';

                                $http.get('/LegalHeir/GetClaimentLegalHeir/' + doc.id)
                                    .then(function (response) {

                                        $scope.heir = response.data;

                                        var heirs = response.data.find(x => x.id === hid);
                                        var holder = heirs;

                                        populateData(holder, result, $scope.heir, true, doc);

                                    }, function () {
                                        console.error('Error loading legal heir data');
                                        hideLoader();
                                    });

                            } else {

                                $scope.heirId = null;
                                $scope.data = null;
                                $scope.legalheirlist = false;
                                document.getElementById('heirId').value = '';

                                var holder = doc;
                                populateData(holder, result, $scope.heir, false, doc);
                            }

                            hideLoader();

                        }, function () {
                            console.error('Error loading Docs');
                            hideLoader();
                        });

                    }, function () {
                        console.error('Error loading customers');
                        hideLoader();
                    });
                }

                // ------------------------------------------------------------
                // Load Pre-generated Form (id2 mode)
                // ------------------------------------------------------------
                if (id2) {

                    $scope.hDiv = false;

                    $http.get('/Form/GetGenratedFormById/' + id2).then(function (response) {

                        var result = response.data;
                        var obj = JSON.parse(result.jsonString);

                        $scope.data = {
                            docid: obj.docid,
                            customerName: obj.customerName,
                            firstHolder: obj.firstHolder,
                            secondHolder: obj.secondHolder,
                            thirdHolder: obj.thirdHolder,
                            heirs: obj.heirs,
                            firstAlive: obj.firstAlive,
                            secondAlive: obj.secondAlive,
                            thirdAlive: obj.thirdAlive,
                            mobile: obj.mobile,
                            address: obj.address,
                            officename: obj.officename,
                            officeaddress: obj.officeaddress,
                            unit: obj.unit,
                            folioNo: obj.folioNo,
                            qty: obj.qty,
                            dpid: obj.dpid,
                            clientId: obj.clientId,
                            accountName: obj.accountName,
                            condition: obj.condition,
                        };

                        id = result.stockId;

                        checkData();
                        hideLoader();

                    }, function () {
                        console.error('Error loading customers');
                        hideLoader();
                    });
                }

                // ------------------------------------------------------------
                // Populate Data inside the Form
                // ------------------------------------------------------------
                function populateData(holder, result, heirlist, isDeceased, doc) {

                    $scope.data = {
                        docid: holder.id,
                        customerName: holder.name,
                        firstHolder: result.firstHolderName,
                        secondHolder: result.secondHolderName,
                        thirdHolder: result.thirdHolderName,
                        heirs: isDeceased ? heirlist.map(h => ({name: h.name,  dateOfDeath: h.dateOfDeath}) ) : [],
                        firstAlive: result?.firstHolderData?.dateOfDeath,
                        secondAlive: result?.secondHolderData?.dateOfDeath,
                        thirdAlive: result?.thirdHolderData?.dateOfDeath,
                        mobile: !isDeceased ? result.firstHolderData.mobile : holder.mobile,
                        address: !isDeceased ? result.firstHolderData.addressAsPerAadhar : holder.addressAsPerAadhar,
                        officename: result.company.rtaName,
                        officeaddress: result.company.rtaAddress,
                        unit: result.companyName,
                        folioNo: result.folioNo,
                        qty: result.qty,
                        dpid: holder.dpid,
                        clientId: holder.clientId,
                        accountName: $scope.data?.accountName || 'Suspense Escrow Demat Account',
                        condition: isDeceased,
                    };

                }
            };

            // ------------------------------------------------------------
            // Navigate to Generate Form Page
            // ------------------------------------------------------------
            $scope.navtogenerateform = function () {
                window.open('/Form/GenerateForm/' + id, '_self');
            };

            // ------------------------------------------------------------
            // Auto Print when opening a stored form
            // ------------------------------------------------------------
            function checkData() {
                if ($scope.data !== undefined) {
                    $timeout(function () {
                        $scope.printDiv('printForm');
                    }, 0);
                } else {
                    setTimeout(checkData, 1000);
                }
            }

            // ------------------------------------------------------------
            // Generate Form
            // ------------------------------------------------------------
            $scope.genrateForm = function () {

                if (id) {

                    $scope.processdone = true;

                    let jsonString = JSON.stringify($scope.data, null, 2);

                    var data = {
                        formName: 'Escrow Suspended REQUEST LETTER',
                        StockId: id,
                        url: '/Form/EscrowSuspendedREQUESTLETTER?id2=',
                        jsonString: jsonString,
                        ClientName: $scope.data.customerName,
                        ClientId: $scope.data.docid,
                        IsActive: true
                    };

                    $http.post('/Form/GenrateForm', data).then(function (response) {

                        if (response.data.success) {

                            Swal.fire({
                                title: 'Success',
                                text: response.data.message || 'Operation successful!',
                                icon: 'success',
                                confirmButtonText: 'OK'
                            });

                            $scope.processdone = false;

                            window.open(response.data.data.url + response.data.data.id, '_self');

                        } else {

                            Swal.fire({
                                title: 'This Form already Exists',
                                text: "Do you want to go to that form?",
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Yes',
                                cancelButtonText: 'No'
                            }).then(res => {
                                if (res.isConfirmed) {
                                    window.open(response.data.message, '_self');
                                }
                            });

                            $scope.processdone = false;
                        }

                        isProcessing = false;

                    }, function () {
                        Swal.fire({
                            title: 'Error',
                            text: 'An error occurred.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });

                        $scope.processdone = false;
                        isProcessing = false;
                    });
                }
            };

            // ------------------------------------------------------------
            // Print Function
            // ------------------------------------------------------------
            $scope.printDiv = function (divId) {

                var css = `<style>* {
            margin: 0;
            padding: 0;
            text-indent: 0;
        }

        h1 {
            color: black;
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 18pt;
            text-decoration: none;
        }

        /* Text Styles */
        .s1 {
            color: black;
            font-family: Calibri, sans-serif;
            font-size: 14pt;
        }

        .s2 {
            color: black;
            font-family: "Times New Roman", serif;
            font-size: 12pt;
        }

        .p, p {
            color: black;
            font-family: Calibri, sans-serif;
            font-size: 12pt;
            margin: 0;
        }

        .s3 {
            color: black;
            font-family: Calibri, sans-serif;
            font-size: 12pt;
            text-decoration: underline;
        }

        .s4 {
            color: black;
            font-family: Cambria, serif;
            font-size: 10pt;
        }

        .s5 {
            color: black;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 11pt;
            text-decoration: underline;
        }

        .s7 {
            color: black;
            font-family: Calibri, sans-serif;
            font-weight: bold;
            font-size: 11pt;
        }

        .h3 {
            color: #212121;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 11pt;
            text-decoration: underline;
        }

        .s8,
        .s9 {
            color: black;
            font-family: Calibri, sans-serif;
            font-size: 11pt;
        }

        /* Components */
        .card {
            border-radius: 10px;
            overflow: hidden;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        /* Buttons */
        .btn-primary {
            width: 100%;
            padding: 12px 16px;
            text-transform: uppercase;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

            .btn-primary:hover {
                background-color: #0056b3;
                transform: scale(1.05);
            }

        .mybtn {
            background-color: #51b37f !important;
            color: white !important;
            width: auto !important;
        }

        .myarea {
            display: flex !important;
            justify-content: center !important;
            margin-top: 25px !important;
        }
        @@media print {.hide-print {display: none !important;}}</style>`;
                var innerContents = document.getElementById(divId).innerHTML;

                var popup = window.open('', '_blank',
                    'width=600,height=700,scrollbars=no,menubar=no,toolbar=no,location=no,status=no,titlebar=no');

                popup.document.open();
                popup.document.write(`
                    <html>
                        <head>
                            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
                            ${css}
                        </head>
                        <body style="padding: 0 5%" onload="window.print()">
                            ${innerContents}
                        </body>
                    </html>
                `);

                popup.document.close();
            };

            // ------------------------------------------------------------
            // Initialize
            // ------------------------------------------------------------
            $scope.loadCustomers();
        });
</script>
